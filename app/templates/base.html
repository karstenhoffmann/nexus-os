
{%- from "macros/icons.html" import icon -%}
<!doctype html>
<html lang="de" data-theme="cupcake">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>nexus-os</title>
  <!-- Custom CSS first (existing design system) -->
  <link rel="stylesheet" href="/static/app.css">
  <!-- Tailwind + DaisyUI last (takes precedence for migrated components) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" type="text/css" />
  <!-- DaisyUI theme: using built-in "cupcake" (light) and "dark" themes -->
  <script defer src="/static/htmx.min.js"></script>
  <script defer src="/static/alpine.min.js"></script>
  <script>
    // Theme-Presets mit CSS-Variable-Mappings
    const themePresets = {
      spacing: {
        compact: {
          '--card-padding': '0.875rem',
          '--card-gap': '0.875rem',
          '--section-gap': '1rem',
          '--button-padding-x': '0.75rem',
          '--button-padding-y': '0.5rem',
          '--space-md': '0.75rem',
          '--space-lg': '1rem'
        },
        normal: {
          '--card-padding': '1.25rem',
          '--card-gap': '1.25rem',
          '--section-gap': '1.5rem',
          '--button-padding-x': '1rem',
          '--button-padding-y': '0.625rem',
          '--space-md': '1rem',
          '--space-lg': '1.5rem'
        },
        spacious: {
          '--card-padding': '1.75rem',
          '--card-gap': '1.75rem',
          '--section-gap': '2rem',
          '--button-padding-x': '1.25rem',
          '--button-padding-y': '0.75rem',
          '--space-md': '1.25rem',
          '--space-lg': '2rem'
        }
      },
      radius: {
        sharp: {
          '--radius-sm': '2px',
          '--radius-md': '4px',
          '--radius-lg': '6px',
          '--radius-xl': '8px'
        },
        rounded: {
          '--radius-sm': '6px',
          '--radius-md': '8px',
          '--radius-lg': '12px',
          '--radius-xl': '16px'
        },
        pill: {
          '--radius-sm': '10px',
          '--radius-md': '14px',
          '--radius-lg': '20px',
          '--radius-xl': '28px'
        }
      },
      fontSize: {
        small: {
          '--font-size-xs': '0.7rem',
          '--font-size-sm': '0.8rem',
          '--font-size-base': '0.9rem',
          '--font-size-lg': '1rem',
          '--font-size-xl': '1.1rem',
          '--font-size-2xl': '1.3rem',
          '--font-size-3xl': '1.6rem'
        },
        medium: {
          '--font-size-xs': '0.75rem',
          '--font-size-sm': '0.875rem',
          '--font-size-base': '1rem',
          '--font-size-lg': '1.125rem',
          '--font-size-xl': '1.25rem',
          '--font-size-2xl': '1.5rem',
          '--font-size-3xl': '1.875rem'
        },
        large: {
          '--font-size-xs': '0.8rem',
          '--font-size-sm': '0.95rem',
          '--font-size-base': '1.1rem',
          '--font-size-lg': '1.25rem',
          '--font-size-xl': '1.4rem',
          '--font-size-2xl': '1.7rem',
          '--font-size-3xl': '2.1rem'
        }
      }
    };

    // Theme anwenden (global verfuegbar)
    window.applyTheme = function(theme) {
      const root = document.documentElement;

      // Primaerfarbe
      if (theme.primary) {
        root.style.setProperty('--primary', theme.primary);
        // Hover-Farbe berechnen (etwas dunkler)
        const hex = theme.primary.replace('#', '');
        const r = parseInt(hex.substr(0,2), 16);
        const g = parseInt(hex.substr(2,2), 16);
        const b = parseInt(hex.substr(4,2), 16);
        const hover = '#' + [r,g,b].map(c => Math.max(0, c - 30).toString(16).padStart(2,'0')).join('');
        root.style.setProperty('--primary-hover', hover);
        // Light-Variante
        root.style.setProperty('--primary-light', theme.primary + '1a');
      }

      // Spacing Preset
      if (theme.spacing && themePresets.spacing[theme.spacing]) {
        Object.entries(themePresets.spacing[theme.spacing]).forEach(([prop, val]) => {
          root.style.setProperty(prop, val);
        });
      }

      // Radius Preset
      if (theme.radius && themePresets.radius[theme.radius]) {
        Object.entries(themePresets.radius[theme.radius]).forEach(([prop, val]) => {
          root.style.setProperty(prop, val);
        });
      }

      // Font Size Preset
      if (theme.fontSize && themePresets.fontSize[theme.fontSize]) {
        Object.entries(themePresets.fontSize[theme.fontSize]).forEach(([prop, val]) => {
          root.style.setProperty(prop, val);
        });
      }
    };

    // Theme aus DB laden und anwenden
    fetch('/api/admin/theme')
      .then(r => r.json())
      .then(theme => window.applyTheme(theme))
      .catch(() => {}); // Ignoriere Fehler, Default-Werte greifen

    // Dark Mode Toggle (cupcake <-> dark)
    window.toggleTheme = function() {
      const root = document.documentElement;
      const current = root.getAttribute('data-theme');

      // Toggle between cupcake (light) and dark
      const newTheme = current === 'dark' ? 'cupcake' : 'dark';

      root.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    };

    window.updateThemeIcon = function(theme) {
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;
      const isDark = theme === 'dark';
      btn.title = isDark ? 'Light Mode' : 'Dark Mode';
      // Toggle icon visibility via classes
      const moonIcon = btn.querySelector('.icon-moon');
      const sunIcon = btn.querySelector('.icon-sun');
      if (moonIcon && sunIcon) {
        moonIcon.style.display = isDark ? 'none' : 'block';
        sunIcon.style.display = isDark ? 'block' : 'none';
      }
    };

    // Restore saved theme on load
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('theme');
      if (saved && (saved === 'dark' || saved === 'cupcake')) {
        document.documentElement.setAttribute('data-theme', saved);
      }
      // Default is cupcake (set in HTML), so use that if no valid saved theme
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'cupcake';
      updateThemeIcon(currentTheme);

      // Set active nav link
      const path = window.location.pathname;
      document.querySelectorAll('.nav a').forEach(a => {
        const href = a.getAttribute('href');
        if (path === href || (href !== '/' && path.startsWith(href))) {
          a.classList.add('active');
        }
      });
    });
  </script>
</head>
<body>
  <header class="topbar">
    <div class="container row">
      <div class="brand"><a href="/">nexus-os</a></div>
      <nav class="nav">
        <a href="/library">{{ icon("book-open") }} Library</a>
        <a href="/digest">{{ icon("zap") }} Digest</a>
        <a href="/drafts">{{ icon("edit-3") }} Drafts</a>
        <a href="/sync">{{ icon("refresh-cw") }} Sync</a>
        <a href="/admin">{{ icon("settings") }} Admin</a>
        <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
          {{ icon("moon", "icon-moon") }}
          {{ icon("sun", "icon-sun") }}
        </button>
      </nav>
    </div>
  </header>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <footer class="container footer">
    <div>Local-first. Single user. Guardrails on.</div>
  </footer>

  <!-- HTMX Toast Container -->
  <div id="htmx-toast-container" class="htmx-toast-container"></div>

  <!-- HTMX Error Handling -->
  <script>
    (function() {
      // SVG Icons als Strings (für Toast-Notifications)
      const icons = {
        error: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
        success: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
        retry: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>'
      };

      // Toast anzeigen
      function showToast(message, type = 'error', duration = 4000) {
        const container = document.getElementById('htmx-toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'htmx-toast toast-' + type;
        toast.innerHTML = icons[type] + '<span>' + message + '</span>';
        container.appendChild(toast);

        // Auto-remove
        setTimeout(() => {
          toast.classList.add('removing');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Error-HTML für Target-Replacement
      function createErrorHTML(message, retryUrl, retryTarget) {
        return '<div class="htmx-error-container">' +
          icons.error.replace('width="24"', 'class="error-icon" width="40"').replace('height="24"', 'height="40"') +
          '<div class="error-title">Fehler beim Laden</div>' +
          '<div class="error-message">' + message + '</div>' +
          (retryUrl ? '<button class="btn btn-retry" onclick="htmxRetry(this, \'' + retryUrl + '\', \'' + retryTarget + '\')">' +
            icons.retry.replace('width="24"', 'width="16"').replace('height="24"', 'height="16"') +
            ' Erneut versuchen</button>' : '') +
          '</div>';
      }

      // Retry-Funktion global verfügbar machen
      window.htmxRetry = function(btn, url, target) {
        const targetEl = document.querySelector(target);
        if (targetEl && window.htmx) {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span> Lädt...';
          htmx.ajax('GET', url, { target: target, swap: 'innerHTML' });
        }
      };

      // HTMX Response Error (4xx, 5xx)
      document.body.addEventListener('htmx:responseError', function(evt) {
        const xhr = evt.detail.xhr;
        const target = evt.detail.target;
        const path = evt.detail.pathInfo?.requestPath || '';

        let message = 'Server-Fehler';
        if (xhr.status === 404) {
          message = 'Nicht gefunden';
        } else if (xhr.status === 500) {
          message = 'Interner Server-Fehler';
        } else if (xhr.status >= 400) {
          message = 'Fehler ' + xhr.status;
        }

        // Für größere Container: Error-HTML anzeigen
        if (target && target.offsetHeight > 50) {
          target.innerHTML = createErrorHTML(message, path, '#' + (target.id || ''));
        } else {
          // Für kleine Elemente: Toast anzeigen
          showToast(message + ': ' + path, 'error');
        }
      });

      // HTMX Send Error (Netzwerk-Fehler)
      document.body.addEventListener('htmx:sendError', function(evt) {
        const target = evt.detail.target;
        const path = evt.detail.pathInfo?.requestPath || '';

        if (target && target.offsetHeight > 50) {
          target.innerHTML = createErrorHTML('Netzwerkfehler - Verbindung prüfen', path, '#' + (target.id || ''));
        } else {
          showToast('Netzwerkfehler - Verbindung prüfen', 'error');
        }
      });

      // HTMX After Swap Success (optional: für Erfolgs-Feedback)
      document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Nur für POST/DELETE/PUT Requests Erfolg anzeigen
        const verb = evt.detail.requestConfig?.verb;
        if (verb && ['post', 'delete', 'put'].includes(verb.toLowerCase())) {
          const path = evt.detail.pathInfo?.requestPath || '';
          if (path.includes('/cancel') || path.includes('/delete')) {
            showToast('Aktion erfolgreich', 'success', 2000);
          }
        }
      });

      // Global verfügbar machen
      window.htmxShowToast = showToast;
    })();
  </script>
</body>
</html>
