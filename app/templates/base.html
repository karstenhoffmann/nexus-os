
{%- from "macros/icons.html" import icon -%}
<!doctype html>
<html lang="de" data-theme="garden">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>nexus-os</title>
  <!-- Custom CSS first (will be overridden by Tailwind/DaisyUI) -->
  <link rel="stylesheet" href="/static/app.css?v=2">
  <!-- Tailwind + DaisyUI (takes precedence) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script defer src="/static/htmx.min.js"></script>
  <script defer src="/static/alpine.min.js"></script>
  <script>
    // Dark Mode Toggle (garden <-> dark)
    window.toggleTheme = function() {
      const root = document.documentElement;
      const current = root.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'garden' : 'dark';
      root.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    };

    window.updateThemeIcon = function(theme) {
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;
      const isDark = theme === 'dark';
      btn.title = isDark ? 'Light Mode' : 'Dark Mode';
      const moonIcon = btn.querySelector('.icon-moon');
      const sunIcon = btn.querySelector('.icon-sun');
      if (moonIcon && sunIcon) {
        moonIcon.style.display = isDark ? 'none' : 'block';
        sunIcon.style.display = isDark ? 'block' : 'none';
      }
    };

    // Restore saved theme on load
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('theme');
      if (saved && (saved === 'dark' || saved === 'garden')) {
        document.documentElement.setAttribute('data-theme', saved);
      }
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'garden';
      updateThemeIcon(currentTheme);
    });
  </script>
</head>
<body class="min-h-screen flex flex-col bg-base-200">
  <!-- DaisyUI Navbar -->
  <div class="navbar bg-neutral text-neutral-content sticky top-0 z-50 shadow-md">
    <div class="navbar-start">
      <a href="/" class="btn btn-ghost text-xl font-bold">nexus-os</a>
    </div>
    <div class="navbar-center hidden lg:flex">
      <ul class="menu menu-horizontal px-1 gap-1">
        <li><a href="/library" class="gap-2">{{ icon("book-open") }} Library</a></li>
        <li><a href="/digest" class="gap-2">{{ icon("zap") }} Digest</a></li>
        <li><a href="/drafts" class="gap-2">{{ icon("edit-3") }} Drafts</a></li>
        <li><a href="/sync" class="gap-2">{{ icon("refresh-cw") }} Sync</a></li>
        <li><a href="/admin" class="gap-2">{{ icon("settings") }} Admin</a></li>
      </ul>
    </div>
    <div class="navbar-end gap-2">
      <!-- Theme toggle -->
      <button id="theme-toggle" class="btn btn-ghost btn-circle" onclick="toggleTheme()" title="Toggle Theme">
        {{ icon("moon", "icon-moon") }}
        {{ icon("sun", "icon-sun") }}
      </button>
      <!-- Mobile menu dropdown -->
      <div class="dropdown dropdown-end lg:hidden">
        <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
          {{ icon("menu") }}
        </div>
        <ul tabindex="0" class="menu menu-sm dropdown-content bg-neutral text-neutral-content rounded-box z-50 mt-3 w-52 p-2 shadow">
          <li><a href="/library" class="gap-2">{{ icon("book-open") }} Library</a></li>
          <li><a href="/digest" class="gap-2">{{ icon("zap") }} Digest</a></li>
          <li><a href="/drafts" class="gap-2">{{ icon("edit-3") }} Drafts</a></li>
          <li><a href="/sync" class="gap-2">{{ icon("refresh-cw") }} Sync</a></li>
          <li><a href="/admin" class="gap-2">{{ icon("settings") }} Admin</a></li>
        </ul>
      </div>
    </div>
  </div>

  <main class="flex-1 container mx-auto px-4 py-6 max-w-6xl">
    {% block content %}{% endblock %}
  </main>

  <footer class="footer footer-center p-4 bg-base-200 text-base-content border-t border-base-300">
    <div>Local-first. Single user. Guardrails on.</div>
  </footer>

  <!-- HTMX Toast Container -->
  <div id="htmx-toast-container" class="htmx-toast-container"></div>

  <!-- HTMX Error Handling -->
  <script>
    (function() {
      // SVG Icons als Strings (für Toast-Notifications)
      const icons = {
        error: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
        success: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
        retry: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>'
      };

      // Toast anzeigen
      function showToast(message, type = 'error', duration = 4000) {
        const container = document.getElementById('htmx-toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'htmx-toast toast-' + type;
        toast.innerHTML = icons[type] + '<span>' + message + '</span>';
        container.appendChild(toast);

        // Auto-remove
        setTimeout(() => {
          toast.classList.add('removing');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Error-HTML für Target-Replacement
      function createErrorHTML(message, retryUrl, retryTarget) {
        return '<div class="htmx-error-container">' +
          icons.error.replace('width="24"', 'class="error-icon" width="40"').replace('height="24"', 'height="40"') +
          '<div class="error-title">Fehler beim Laden</div>' +
          '<div class="error-message">' + message + '</div>' +
          (retryUrl ? '<button class="btn btn-retry" onclick="htmxRetry(this, \'' + retryUrl + '\', \'' + retryTarget + '\')">' +
            icons.retry.replace('width="24"', 'width="16"').replace('height="24"', 'height="16"') +
            ' Erneut versuchen</button>' : '') +
          '</div>';
      }

      // Retry-Funktion global verfügbar machen
      window.htmxRetry = function(btn, url, target) {
        const targetEl = document.querySelector(target);
        if (targetEl && window.htmx) {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span> Lädt...';
          htmx.ajax('GET', url, { target: target, swap: 'innerHTML' });
        }
      };

      // HTMX Response Error (4xx, 5xx)
      document.body.addEventListener('htmx:responseError', function(evt) {
        const xhr = evt.detail.xhr;
        const target = evt.detail.target;
        const path = evt.detail.pathInfo?.requestPath || '';

        let message = 'Server-Fehler';
        if (xhr.status === 404) {
          message = 'Nicht gefunden';
        } else if (xhr.status === 500) {
          message = 'Interner Server-Fehler';
        } else if (xhr.status >= 400) {
          message = 'Fehler ' + xhr.status;
        }

        // Für größere Container: Error-HTML anzeigen
        if (target && target.offsetHeight > 50) {
          target.innerHTML = createErrorHTML(message, path, '#' + (target.id || ''));
        } else {
          // Für kleine Elemente: Toast anzeigen
          showToast(message + ': ' + path, 'error');
        }
      });

      // HTMX Send Error (Netzwerk-Fehler)
      document.body.addEventListener('htmx:sendError', function(evt) {
        const target = evt.detail.target;
        const path = evt.detail.pathInfo?.requestPath || '';

        if (target && target.offsetHeight > 50) {
          target.innerHTML = createErrorHTML('Netzwerkfehler - Verbindung prüfen', path, '#' + (target.id || ''));
        } else {
          showToast('Netzwerkfehler - Verbindung prüfen', 'error');
        }
      });

      // HTMX After Swap Success (optional: für Erfolgs-Feedback)
      document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Nur für POST/DELETE/PUT Requests Erfolg anzeigen
        const verb = evt.detail.requestConfig?.verb;
        if (verb && ['post', 'delete', 'put'].includes(verb.toLowerCase())) {
          const path = evt.detail.pathInfo?.requestPath || '';
          if (path.includes('/cancel') || path.includes('/delete')) {
            showToast('Aktion erfolgreich', 'success', 2000);
          }
        }
      });

      // Global verfügbar machen
      window.htmxShowToast = showToast;
    })();
  </script>
</body>
</html>
