{% extends "base.html" %}
{% from "macros/icons.html" import icon %}
{% block content %}

<!-- Breadcrumb -->
<div class="text-sm breadcrumbs mb-4">
  <ul>
    <li><a href="/library" class="link link-hover gap-1">{{ icon("arrow-left") }} Zurueck zur Bibliothek</a></li>
  </ul>
</div>

{% if error %}
<div class="alert alert-error mb-4">
  {{ icon("alert-circle") }} {{ error }}
</div>
{% endif %}

{% if doc %}
<article class="max-w-3xl mx-auto" x-data="documentApp()">

  <!-- Header with metadata -->
  <header class="card bg-base-100 shadow-md mb-6">
    <div class="card-body">
      <h1 class="card-title text-2xl">{{ doc.title or "Ohne Titel" }}</h1>

      <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-base-content/70 mt-2">
        {% if doc.author %}
        <div class="flex items-center gap-1">
          {{ icon("user") }}
          <span>{{ doc.author }}</span>
        </div>
        {% endif %}

        {% if doc.category %}
        <div class="flex items-center">
          {# Category badge mapping to DaisyUI semantic colors #}
          {% set cat = doc.category %}
          <span class="badge badge-sm {% if cat == 'article' %}badge-primary{% elif cat == 'pdf' %}badge-error{% elif cat == 'podcast' %}badge-warning{% elif cat == 'video' %}badge-success{% elif cat in ['tweet', 'linkedin'] %}badge-info{% elif cat == 'epub' %}badge-secondary{% elif cat == 'note' %}badge-accent{% else %}badge-ghost{% endif %}">{{ cat }}</span>
        </div>
        {% endif %}

        {% if doc.word_count %}
        <div class="flex items-center gap-1">
          {{ icon("file-text") }}
          <span>{{ "{:,}".format(doc.word_count).replace(",", ".") }} Woerter</span>
        </div>
        {% endif %}

        {% if doc.saved_at %}
        <div class="flex items-center gap-1">
          {{ icon("bookmark") }}
          <span>Gespeichert: {{ doc.saved_at[:10] }}</span>
        </div>
        {% endif %}

        {% if doc.published_at %}
        <div class="flex items-center gap-1">
          {{ icon("calendar") }}
          <span>Veroeffentlicht: {{ doc.published_at[:10] }}</span>
        </div>
        {% endif %}

        {% if doc.url_original %}
        <div class="flex items-center gap-1">
          <a href="{{ doc.url_original }}" target="_blank" rel="noopener" class="link link-primary gap-1">
            {{ icon("external-link") }} Original
          </a>
        </div>
        {% endif %}

        <div class="flex items-center text-base-content/50">
          <span>Quelle: {{ doc.source }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Summary Section -->
  {% if doc.summary %}
  <section class="card bg-base-100 shadow-md mb-6">
    <div class="card-body">
      <div class="flex justify-between items-center border-b border-base-300 pb-3 mb-4">
        <h2 class="flex items-center gap-2 text-lg font-semibold m-0">{{ icon("align-left") }} Zusammenfassung</h2>
      </div>
      <div class="prose prose-sm max-w-none text-base-content/80">
        {{ doc.summary|markdown|safe }}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Highlights Section -->
  {% if highlights %}
  <section class="card bg-base-100 shadow-md mb-6">
    <div class="card-body">
      <div class="flex justify-between items-center border-b border-base-300 pb-3 mb-4">
        <h2 class="flex items-center gap-2 text-lg font-semibold m-0">{{ icon("bookmark") }} Highlights ({{ highlights|length }})</h2>
      </div>
      <ul class="flex flex-col gap-4 list-none p-0 m-0">
        {% for h in highlights %}
        <li class="flex gap-4 p-4 bg-base-200 rounded-lg border-l-4 border-warning">
          <div class="flex-1 min-w-0">
            <blockquote class="m-0 italic leading-relaxed">{{ h.text|markdown|safe }}</blockquote>
            {% if h.note %}
            <p class="mt-2 text-sm text-base-content/70 flex items-start gap-1 not-italic">
              {{ icon("message-circle") }} {{ h.note }}
            </p>
            {% endif %}
            {% if h.highlighted_at %}
            <p class="mt-1 text-xs text-base-content/50">{{ h.highlighted_at[:10] }}</p>
            {% endif %}
          </div>
          <button class="btn btn-ghost btn-sm opacity-50 hover:opacity-100 flex-shrink-0" @click="copyToClipboard($event, '{{ h.text|e|replace("'", "\\'") }}')" title="Markdown kopieren">
            {{ icon("copy") }}
          </button>
        </li>
        {% endfor %}
      </ul>
    </div>
  </section>
  {% endif %}

  <!-- Fulltext Section -->
  {% if doc.fulltext %}
  <section class="card bg-base-100 shadow-md mb-6">
    <div class="card-body">
      <div class="flex justify-between items-center border-b border-base-300 pb-3 mb-4">
        <h2 class="flex items-center gap-2 text-lg font-semibold m-0">{{ icon("file-text") }} Inhalt</h2>
        <button class="btn btn-outline btn-sm opacity-50 hover:opacity-100" @click="copyFulltext($event)" title="Rohen Text kopieren">
          {{ icon("copy") }} Kopieren
        </button>
      </div>
      <div class="prose prose-sm max-w-none">
        {{ doc.fulltext|markdown|safe }}
      </div>
    </div>
  </section>
  {% elif not highlights %}
  <div class="card bg-base-100 shadow-md">
    <div class="card-body items-center text-center py-12">
      {{ icon("inbox") }}
      <p class="text-base-content/50 mt-4">Kein Inhalt fuer dieses Dokument verfuegbar.</p>
    </div>
  </div>
  {% endif %}

</article>

<script>
const rawFulltext = {{ doc.fulltext|tojson|safe if doc.fulltext else '""' }};

function documentApp() {
  return {
    async copyToClipboard(event, text) {
      try {
        await navigator.clipboard.writeText(text);
        this.showCopyFeedback(event.currentTarget);
      } catch (err) {
        console.error('Copy failed:', err);
      }
    },
    async copyFulltext(event) {
      try {
        await navigator.clipboard.writeText(rawFulltext);
        this.showCopyFeedback(event.currentTarget);
      } catch (err) {
        console.error('Copy failed:', err);
      }
    },
    showCopyFeedback(button) {
      const originalHTML = button.innerHTML;
      button.innerHTML = 'âœ“';
      button.classList.add('text-success');
      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('text-success');
      }, 1500);
    }
  };
}
</script>
{% endif %}

{% endblock %}
