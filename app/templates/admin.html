{% extends "base.html" %}
{% from "macros/icons.html" import icon %}
{% block content %}

<div x-data="{ activeTab: 'status', ...embeddingJob(), ...themeEditor() }" x-init="init(); loadTheme()">

  <!-- Hero -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold">Admin</h1>
      <p class="text-base-content/60 text-sm mt-1">System-Status, Werkzeuge und Einstellungen</p>
    </div>
  </div>

  <!-- Quick Stats Bar -->
  <div class="stats stats-vertical sm:stats-horizontal shadow bg-base-100 w-full mb-6">
    <div class="stat py-3 px-4">
      <div class="stat-title text-xs">Dokumente</div>
      <div class="stat-value text-xl">{{ stats.documents }}</div>
    </div>
    <div class="stat py-3 px-4">
      <div class="stat-title text-xs">Highlights</div>
      <div class="stat-value text-xl">{{ stats.highlights }}</div>
    </div>
    <div class="stat py-3 px-4">
      <div class="stat-title text-xs">Entwuerfe</div>
      <div class="stat-value text-xl">{{ stats.drafts }}</div>
    </div>
    <div class="stat py-3 px-4">
      <div class="stat-title text-xs">Embeddings</div>
      <div class="stat-value text-xl" :class="{ 'text-success': pending === 0, 'text-warning': pending > 0 }" x-text="progress + '%'"></div>
      <div class="stat-desc" x-text="pending === 0 ? 'komplett' : pending.toLocaleString() + ' ausstehend'"></div>
    </div>
  </div>

  <!-- DaisyUI v5 Tabs Lift with Labels -->
  <div class="tabs tabs-lift w-full">

    <!-- Tab 1: Status -->
    <label class="tab">
      <input type="radio" name="admin_tabs" checked="checked" />
      {{ icon("activity") }}
      Status
    </label>
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Environment Section -->
        <div>
          <h3 class="font-semibold text-sm text-base-content/70 uppercase tracking-wide mb-3">{{ icon("server") }} Umgebung</h3>
          <div class="divide-y divide-base-200 bg-base-200/30 rounded-lg px-4">
            <div class="flex justify-between py-3 text-sm">
              <span class="text-base-content/60">Modus</span>
              <span class="font-medium">{{ settings.app_env }}</span>
            </div>
            <div class="flex justify-between py-3 text-sm">
              <span class="text-base-content/60">Datenbank</span>
              <span class="font-medium font-mono text-xs">{{ settings.db_path }}</span>
            </div>
            <div class="flex justify-between py-3 text-sm">
              <span class="text-base-content/60">LLM-Anbieter</span>
              <span class="font-medium">{{ settings.llm_provider }}</span>
            </div>
          </div>
        </div>
        <!-- Embeddings Section -->
        <div>
          <h3 class="font-semibold text-sm text-base-content/70 uppercase tracking-wide mb-3">{{ icon("cpu") }} Semantische Suche</h3>
          <div class="bg-base-200/30 rounded-lg p-4">
            <div class="mb-3">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm" x-text="statusText"></span>
                <span class="text-sm font-medium" x-text="progress + '%'"></span>
              </div>
              <progress class="progress progress-primary w-full h-2" :value="progress" max="100"></progress>
              <div class="text-xs text-base-content/50 mt-1" x-text="totalEmbedded.toLocaleString() + ' / ' + stats.total_chunks.toLocaleString() + ' Chunks'"></div>
            </div>
            <template x-if="stats.by_provider && stats.by_provider.length > 0">
              <div class="text-xs text-base-content/50 mb-3">
                Anbieter: <span class="font-medium" x-text="stats.by_provider.map(p => p.provider + '/' + p.model).join(', ')"></span>
              </div>
            </template>
            <div x-show="pending > 0">
              <div x-show="!jobRunning">
                <button class="btn btn-primary btn-sm gap-2" @click="startJob()">{{ icon("play") }} Embeddings generieren</button>
              </div>
              <div x-show="jobRunning" class="flex items-center gap-3">
                <span class="loading loading-spinner loading-sm text-primary"></span>
                <div class="flex-1">
                  <div class="text-sm font-medium" x-text="jobStatus"></div>
                  <div class="text-xs text-base-content/50" x-text="'Welle ' + currentBatch"></div>
                </div>
                <button class="btn btn-ghost btn-xs" @click="stopJob()">Stop</button>
              </div>
            </div>
            <div x-show="pending === 0 && stats.total_chunks > 0" class="flex items-center gap-2 text-success text-sm">
              {{ icon("check-circle") }} Alle Chunks haben Embeddings
            </div>
            <div x-show="lastResult" class="alert alert-success mt-3 py-2 text-sm" x-text="lastResult"></div>
            <div x-show="error" class="alert alert-error mt-3 py-2 text-sm" x-text="error"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 2: Werkzeuge -->
    <label class="tab">
      <input type="radio" name="admin_tabs" />
      {{ icon("tool") }}
      Werkzeuge
    </label>
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href="/admin/compare" class="group block p-4 bg-base-200/30 rounded-lg hover:bg-base-200/60 transition-colors">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 flex items-center justify-center bg-base-content/10 text-base-content/70 rounded">{{ icon("git-compare") }}</div>
            <h3 class="font-semibold group-hover:text-primary transition-colors">Modell-Vergleich</h3>
          </div>
          <p class="text-sm text-base-content/60">Suchergebnisse von OpenAI vs Ollama nebeneinander vergleichen.</p>
        </a>
        <a href="/admin/fetch" class="group block p-4 bg-base-200/30 rounded-lg hover:bg-base-200/60 transition-colors">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 flex items-center justify-center bg-base-content/10 text-base-content/70 rounded">{{ icon("download-cloud") }}</div>
            <h3 class="font-semibold group-hover:text-primary transition-colors">Fulltext Fetching</h3>
          </div>
          <p class="text-sm text-base-content/60">Volltexte von Original-URLs laden wenn nur Titel/Summary vorhanden.</p>
        </a>
        <a href="/admin/prompts" class="group block p-4 bg-base-200/30 rounded-lg hover:bg-base-200/60 transition-colors">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 flex items-center justify-center bg-base-content/10 text-base-content/70 rounded">{{ icon("message-square") }}</div>
            <h3 class="font-semibold group-hover:text-primary transition-colors">Prompt-Vorlagen</h3>
          </div>
          <p class="text-sm text-base-content/60">Prompts fuer Digest-Generierung anpassen. Temperature und Tokens.</p>
        </a>
      </div>
    </div>

    <!-- Tab 3: Einstellungen -->
    <label class="tab">
      <input type="radio" name="admin_tabs" />
      {{ icon("settings") }}
      Einstellungen
    </label>
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <h3 class="font-semibold text-sm text-base-content/70 uppercase tracking-wide mb-3">{{ icon("palette") }} Design</h3>
      <p class="text-sm text-base-content/60 mb-4">Erscheinungsbild anpassen. Dark Mode wird vom System uebernommen.</p>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-base-200/30 rounded-lg p-4">
        <div class="form-control">
          <label class="label py-1"><span class="label-text text-xs">Primaerfarbe</span></label>
          <div class="flex items-center gap-2">
            <input type="color" x-model="primary" @change="saveTheme()" class="w-8 h-8 rounded cursor-pointer border-0">
            <span x-text="primary" class="font-mono text-xs text-base-content/50"></span>
          </div>
        </div>
        <div class="form-control">
          <label class="label py-1"><span class="label-text text-xs">Abstaende</span></label>
          <select x-model="spacing" @change="saveTheme()" class="select select-bordered select-sm w-full">
            <option value="compact">Kompakt</option>
            <option value="normal">Normal</option>
            <option value="spacious">Grosszuegig</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label py-1"><span class="label-text text-xs">Ecken</span></label>
          <select x-model="radius" @change="saveTheme()" class="select select-bordered select-sm w-full">
            <option value="sharp">Eckig</option>
            <option value="rounded">Gerundet</option>
            <option value="pill">Stark gerundet</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label py-1"><span class="label-text text-xs">Schriftgroesse</span></label>
          <select x-model="fontSize" @change="saveTheme()" class="select select-bordered select-sm w-full">
            <option value="small">Klein</option>
            <option value="medium">Normal</option>
            <option value="large">Gross</option>
          </select>
        </div>
      </div>
      <div class="flex items-center gap-4 mt-4">
        <button class="btn btn-ghost btn-sm" @click="resetTheme()">Zuruecksetzen</button>
        <span x-show="saved" x-transition class="text-success text-sm">{{ icon("check") }} Gespeichert</span>
      </div>
    </div>

  </div>

</div>

<script>
function embeddingJob() {
  return {
    stats: { total_documents: 0, total_chunks: 0, by_provider: [], legacy_embeddings: 0 },
    jobRunning: false,
    jobStatus: '',
    currentBatch: 0,
    lastResult: null,
    error: null,
    stopRequested: false,

    get totalEmbedded() {
      if (!this.stats.by_provider) return 0;
      return this.stats.by_provider.reduce((sum, p) => sum + (p.chunk_embeddings || 0), 0);
    },
    get pending() {
      return Math.max(0, this.stats.total_chunks - this.totalEmbedded);
    },
    get progress() {
      if (this.stats.total_chunks === 0) return 0;
      return Math.round(this.totalEmbedded / this.stats.total_chunks * 100);
    },
    get statusText() {
      if (this.pending === 0) return 'Vollstaendig';
      if (this.jobRunning) return 'Generiere...';
      return 'Bereit';
    },

    init() {
      this.refreshStats();
      setInterval(() => this.refreshStats(), 2000);
    },

    async refreshStats() {
      try {
        const res = await fetch('/api/embeddings/stats');
        if (res.ok) {
          this.stats = await res.json();
        }
      } catch (e) {}
    },

    async startJob() {
      this.jobRunning = true;
      this.error = null;
      this.lastResult = null;
      this.stopRequested = false;
      this.currentBatch = 0;

      const CHUNKS_PER_CALL = 1000;
      let totalProcessed = 0;
      let totalCost = 0;
      let totalDuration = 0;

      while (this.pending > 0 && !this.stopRequested) {
        this.currentBatch++;
        this.jobStatus = `${Math.min(CHUNKS_PER_CALL, this.pending).toLocaleString()} Chunks...`;

        try {
          const res = await fetch(`/api/embeddings/generate-fast?limit=${CHUNKS_PER_CALL}&batch_size=500&max_concurrent=2`, {
            method: 'POST'
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          totalProcessed += data.processed || 0;
          totalCost += data.cost_usd || 0;
          totalDuration += data.duration_seconds || 0;

          await this.refreshStats();

          if (data.chunks_per_second) {
            this.jobStatus = `${data.chunks_per_second} Chunks/Sek`;
          }

          if (data.processed === 0) {
            if (data.error) this.error = data.error;
            break;
          }

          await new Promise(r => setTimeout(r, 200));
        } catch (e) {
          this.error = `Fehler: ${e.message}`;
          break;
        }
      }

      this.jobRunning = false;
      if (!this.error && totalProcessed > 0) {
        const avgSpeed = totalDuration > 0 ? Math.round(totalProcessed / totalDuration) : 0;
        this.lastResult = `${totalProcessed.toLocaleString()} Chunks, $${totalCost.toFixed(4)}`;
      }
    },

    stopJob() {
      this.stopRequested = true;
      this.jobStatus = 'Wird gestoppt...';
    }
  };
}

function themeEditor() {
  return {
    primary: '#3b82f6',
    spacing: 'normal',
    radius: 'rounded',
    fontSize: 'medium',
    saved: false,

    async loadTheme() {
      try {
        const res = await fetch('/api/admin/theme');
        const theme = await res.json();
        this.primary = theme.primary || '#3b82f6';
        this.spacing = theme.spacing || 'normal';
        this.radius = theme.radius || 'rounded';
        this.fontSize = theme.fontSize || 'medium';
      } catch (e) {}
    },

    async saveTheme() {
      try {
        const params = new URLSearchParams({
          primary: this.primary,
          spacing: this.spacing,
          radius: this.radius,
          fontSize: this.fontSize
        });
        await fetch('/api/admin/theme?' + params.toString(), { method: 'POST' });

        if (window.applyTheme) {
          window.applyTheme({
            primary: this.primary,
            spacing: this.spacing,
            radius: this.radius,
            fontSize: this.fontSize
          });
        }

        this.saved = true;
        setTimeout(() => this.saved = false, 2000);
      } catch (e) {
        console.error('Theme speichern fehlgeschlagen:', e);
      }
    },

    async resetTheme() {
      this.primary = '#3b82f6';
      this.spacing = 'normal';
      this.radius = 'rounded';
      this.fontSize = 'medium';
      await this.saveTheme();
    }
  };
}
</script>

{% endblock %}
