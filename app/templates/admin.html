{% extends "base.html" %}
{% block content %}

<h1>Admin</h1>

<div class="grid">
  <div class="card">
    <h2>Settings (read-only)</h2>
    <div class="kv"><div>ENV</div><div>{{ settings.app_env }}</div></div>
    <div class="kv"><div>DB</div><div>{{ settings.db_path }}</div></div>
    <div class="kv"><div>LLM_PROVIDER</div><div>{{ settings.llm_provider }}</div></div>
    <div class="kv"><div>Confirm costly</div><div>{{ settings.require_confirm_for_costly_runs }}</div></div>
    <div class="kv"><div>Max LLM/day</div><div>{{ settings.max_llm_calls_per_day }}</div></div>
    <div class="kv"><div>Max Embed/day</div><div>{{ settings.max_embed_calls_per_day }}</div></div>
  </div>

  <div class="card">
    <h2>Stats</h2>
    <div class="kv"><div>Documents</div><div>{{ stats.documents }}</div></div>
    <div class="kv"><div>Highlights</div><div>{{ stats.highlights }}</div></div>
    <div class="kv"><div>Drafts</div><div>{{ stats.drafts }}</div></div>
  </div>

  <div class="card" x-data="{ loading: false, result: null, error: null, pending: {{ embedding_stats.pending }} }">
    <h2>Embeddings</h2>
    <div class="kv"><div>Mit Embedding</div><div>{{ embedding_stats.embedded_documents }}</div></div>
    <div class="kv"><div>Ausstehend</div><div x-text="pending">{{ embedding_stats.pending }}</div></div>
    <div class="kv"><div>Gesamt</div><div>{{ embedding_stats.total_documents }}</div></div>

    {% if embedding_stats.pending > 0 %}
    <div style="margin-top: 1rem;">
      <button
        class="btn"
        :disabled="loading"
        @click="
          loading = true;
          error = null;
          result = null;
          fetch('/admin/embeddings/generate?limit=100', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
              result = data;
              pending = data.remaining;
              loading = false;
            })
            .catch(e => { error = e.message; loading = false; })
        ">
        <span x-show="!loading">Embeddings generieren (100 Dokumente)</span>
        <span x-show="loading">Generiere...</span>
      </button>
      <p x-show="result" class="success" style="margin-top: 0.5rem;">
        Verarbeitet: <span x-text="result?.processed"></span>,
        Fehlgeschlagen: <span x-text="result?.failed"></span>,
        Verbleibend: <span x-text="result?.remaining"></span>
      </p>
      <p x-show="error" class="error" style="margin-top: 0.5rem;" x-text="error"></p>
    </div>
    {% else %}
    <p style="margin-top: 0.5rem; color: green;">Alle Dokumente haben Embeddings.</p>
    {% endif %}
  </div>
</div>

<h2>Naechste Schritte</h2>
<p>Hier kommt spaeter: Runs, Confirm Dialoge, Budget UI, Provider Diagnose.</p>
{% endblock %}
