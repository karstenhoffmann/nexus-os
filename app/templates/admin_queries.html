{% extends "base.html" %}
{% from "macros/icons.html" import icon %}
{% block content %}

<div class="max-w-4xl mx-auto">
  <!-- Page Header -->
  <h1 class="text-2xl font-bold mb-1">Gespeicherte Queries</h1>
  <p class="text-base-content/60 mb-8">Suchen und Highlights aus deiner Bibliothek (Admin-Bereich)</p>

  <!-- Section 1: Neue Query erstellen (Creation at top) -->
  <section class="card bg-base-100 shadow-md mb-8">
    <div class="card-body">
      <h2 class="card-title">
        <span class="inline-flex items-center gap-2 whitespace-nowrap">
          {{ icon("plus-circle", "w-5 h-5 text-primary") }}
          Neue Query
        </span>
      </h2>

      <form method="post" action="/digest/queries/create">
        <div class="flex flex-wrap gap-3 items-center">
          <input type="text" name="name"
                 class="input input-bordered flex-1 min-w-[200px]"
                 placeholder="Name (z.B. 'Machine Learning')" required>
          <input type="text" name="query"
                 class="input input-bordered flex-1 min-w-[200px]"
                 placeholder="Suchbegriff (z.B. 'neural network')" required>
          <select name="mode" class="select select-bordered w-auto">
            <option value="fts">Keyword (FTS)</option>
            <option value="semantic">Semantic</option>
          </select>
          <button type="submit" class="btn btn-primary">
            <span class="inline-flex items-center gap-1 whitespace-nowrap">
              {{ icon("plus", "w-4 h-4") }} Erstellen
            </span>
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- Section 2: Neueste Highlights -->
  <section class="card bg-base-100 shadow-md mb-8">
    <div class="card-body">
      <h2 class="card-title">
        <span class="inline-flex items-center gap-2 whitespace-nowrap">
          {{ icon("bookmark", "w-5 h-5 text-primary") }}
          Neueste Highlights
        </span>
      </h2>
      <p class="text-base-content/60 text-sm mb-4">Die letzten 10 markierten Stellen aus deinen Dokumenten</p>

      {% if highlights %}
      <div class="flex flex-col gap-4">
        {% for h in highlights %}
        <div class="bg-base-200/50 rounded-lg p-4 border-l-4 border-primary">
          <blockquote class="italic leading-relaxed mb-2">
            {{ h.text[:300] }}{% if h.text|length > 300 %}...{% endif %}
          </blockquote>
          <div class="text-sm text-base-content/60">
            <a href="/documents/{{ h.document_id }}" class="link link-primary">{{ h.title or 'Ohne Titel' }}</a>
            {% if h.author %}<span> - {{ h.author }}</span>{% endif %}
            {% if h.highlighted_at %}<span> · {{ h.highlighted_at[:10] }}</span>{% endif %}
          </div>
          {% if h.note %}
          <div class="mt-2 p-2 bg-warning/10 rounded text-sm">{{ h.note }}</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-8 text-base-content/60">
        <p>Noch keine Highlights vorhanden. Markiere interessante Stellen in Readwise Reader!</p>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Section 2: Gespeicherte Queries -->
  <section class="card bg-base-100 shadow-md mb-8">
    <div class="card-body">
      <h2 class="card-title">
        <span class="inline-flex items-center gap-2 whitespace-nowrap">
          {{ icon("search", "w-5 h-5 text-primary") }}
          Gespeicherte Queries
        </span>
      </h2>
      <p class="text-base-content/60 text-sm mb-4">Klicke auf eine Query, um die Ergebnisse zu sehen</p>

      {% if digests %}
      <div class="flex flex-col gap-3">
        {% for d in digests %}
        <div class="collapse collapse-arrow bg-base-200/50 rounded-lg" x-data="{ loaded: false }">
          <input type="checkbox" @change="if(!loaded) { $refs.results{{ d.id }}.dispatchEvent(new Event('load-results')); loaded = true; }" />

          <!-- Collapse Title -->
          <div class="collapse-title font-medium pr-12">
            <div class="flex items-center justify-between">
              <span class="font-semibold">{{ d.name }}</span>
              <span class="badge badge-neutral"
                    hx-get="/api/digests/{{ d.id }}/count"
                    hx-trigger="load"
                    hx-swap="innerHTML">...</span>
            </div>
            <div class="text-sm text-base-content/60 mt-1">
              "{{ d.query }}" · <span class="uppercase">{{ d.mode }}</span>
            </div>
          </div>

          <!-- Collapse Content -->
          <div class="collapse-content">
            <!-- Actions -->
            <div class="flex gap-2 mb-4 pt-2" x-data="{ editing: false }">
              <button class="btn btn-ghost btn-sm" @click.stop="editing = !editing">
                <span class="inline-flex items-center gap-1 whitespace-nowrap">
                  <span x-show="!editing">{{ icon("edit-2", "w-4 h-4") }} Bearbeiten</span>
                  <span x-show="editing">{{ icon("x", "w-4 h-4") }} Abbrechen</span>
                </span>
              </button>
              <form method="post" action="/digest/queries/{{ d.id }}/delete" class="inline">
                <button type="submit" class="btn btn-ghost btn-sm text-error hover:bg-error/10"
                        onclick="return confirm('Wirklich loeschen?')">
                  <span class="inline-flex items-center gap-1 whitespace-nowrap">
                    {{ icon("trash-2", "w-4 h-4") }} Loeschen
                  </span>
                </button>
              </form>

              <!-- Inline Edit Form -->
              <div x-show="editing" x-transition class="w-full mt-4">
                <form method="post" action="/digest/queries/{{ d.id }}/update"
                      class="flex flex-wrap gap-2 items-center bg-base-100 p-4 rounded-lg">
                  <input type="text" name="name" value="{{ d.name }}"
                         class="input input-bordered input-sm flex-1 min-w-[150px]" placeholder="Name" required>
                  <input type="text" name="query" value="{{ d.query }}"
                         class="input input-bordered input-sm flex-1 min-w-[150px]" placeholder="Query" required>
                  <select name="mode" class="select select-bordered select-sm">
                    <option value="fts" {% if d.mode == 'fts' %}selected{% endif %}>Keyword (FTS)</option>
                    <option value="semantic" {% if d.mode == 'semantic' %}selected{% endif %}>Semantic</option>
                  </select>
                  <button type="submit" class="btn btn-primary btn-sm">
                    <span class="inline-flex items-center gap-1 whitespace-nowrap">
                      {{ icon("check", "w-4 h-4") }} Speichern
                    </span>
                  </button>
                </form>
              </div>
            </div>

            <!-- Results (lazy load) -->
            <div class="bg-base-100 rounded-lg p-4"
                 x-ref="results{{ d.id }}"
                 hx-get="/api/digests/{{ d.id }}/results"
                 hx-trigger="load-results"
                 hx-swap="innerHTML">
              <div class="text-center text-base-content/60">
                <span class="loading loading-spinner loading-sm"></span>
                Lade Ergebnisse...
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-8 text-base-content/60">
        <p>Noch keine gespeicherten Queries. Erstelle deine erste unten!</p>
      </div>
      {% endif %}
    </div>
  </section>

</div>

{% endblock %}
