{% extends "base.html" %}
{% block content %}

<h1>Gespeicherte Queries</h1>
<p class="subtitle">Suchen und Highlights aus deiner Bibliothek (Admin-Bereich)</p>

<!-- Default Digest: Neueste Highlights -->
<section class="card digest-section">
  <h2><i data-feather="bookmark"></i> Neueste Highlights</h2>
  <p class="muted">Die letzten 10 markierten Stellen aus deinen Dokumenten</p>

  {% if highlights %}
  <div class="highlights-list">
    {% for h in highlights %}
    <div class="highlight-item">
      <blockquote class="highlight-text">{{ h.text[:300] }}{% if h.text|length > 300 %}...{% endif %}</blockquote>
      <div class="highlight-meta">
        <a href="/documents/{{ h.document_id }}">{{ h.title or 'Ohne Titel' }}</a>
        {% if h.author %}<span class="author"> - {{ h.author }}</span>{% endif %}
        {% if h.highlighted_at %}<span class="date"> · {{ h.highlighted_at[:10] }}</span>{% endif %}
      </div>
      {% if h.note %}
      <div class="highlight-note">{{ h.note }}</div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <p>Noch keine Highlights vorhanden. Markiere interessante Stellen in Readwise Reader!</p>
  </div>
  {% endif %}
</section>

<!-- Gespeicherte Queries -->
<section class="digest-section">
  <h2><i data-feather="search"></i> Gespeicherte Queries</h2>
  <p class="muted">Klicke auf eine Query, um die Ergebnisse zu sehen</p>

  {% if digests %}
  <div class="digests-list">
    {% for d in digests %}
    <div class="digest-item card" x-data="{ open: false, editing: false, loaded: false }">
      <!-- Header - Click to expand -->
      <div class="digest-header" @click="open = !open; if(!loaded) { $refs.results.dispatchEvent(new Event('load-results')); loaded = true; }">
        <span class="digest-toggle">
          <i data-feather="chevron-right" x-show="!open"></i>
          <i data-feather="chevron-down" x-show="open"></i>
        </span>
        <span class="digest-name">{{ d.name }}</span>
        <span class="digest-badge badge"
              hx-get="/api/digests/{{ d.id }}/count"
              hx-trigger="load"
              hx-swap="innerHTML">...</span>
      </div>

      <!-- Meta row -->
      <div class="digest-meta">
        <span class="digest-query">"{{ d.query }}"</span>
        <span class="digest-mode">· {{ d.mode|upper }}</span>
      </div>

      <!-- Actions -->
      <div class="digest-actions">
        <button class="btn btn-sm btn-ghost" @click.stop="editing = !editing">
          <i data-feather="x" x-show="editing"></i>
          <i data-feather="edit-2" x-show="!editing"></i>
          <span x-text="editing ? 'Abbrechen' : 'Bearbeiten'"></span>
        </button>
        <form method="post" action="/admin/queries/{{ d.id }}/delete" style="display: inline;">
          <button type="submit" class="btn btn-sm btn-ghost btn-danger-text"
                  onclick="return confirm('Wirklich loeschen?')">
            <i data-feather="trash-2"></i> Loeschen
          </button>
        </form>
      </div>

      <!-- Edit Form (inline, hidden by default) -->
      <div x-show="editing" x-transition class="digest-edit">
        <form method="post" action="/admin/queries/{{ d.id }}/update" class="edit-form">
          <input type="text" name="name" value="{{ d.name }}" class="input" placeholder="Name" required>
          <input type="text" name="query" value="{{ d.query }}" class="input" placeholder="Query" required>
          <select name="mode" class="input">
            <option value="fts" {% if d.mode == 'fts' %}selected{% endif %}>Keyword (FTS)</option>
            <option value="semantic" {% if d.mode == 'semantic' %}selected{% endif %}>Semantic</option>
          </select>
          <button type="submit" class="btn btn-primary btn-sm"><i data-feather="check"></i> Speichern</button>
        </form>
      </div>

      <!-- Results (lazy load on expand) -->
      <div x-show="open" x-transition class="digest-results"
           x-ref="results"
           hx-get="/api/digests/{{ d.id }}/results"
           hx-trigger="load-results"
           hx-swap="innerHTML">
        <div class="loading">Lade Ergebnisse...</div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state card">
    <p>Noch keine gespeicherten Queries. Erstelle deine erste unten!</p>
  </div>
  {% endif %}
</section>

<!-- Neue Query erstellen -->
<section class="card digest-section">
  <h2><i data-feather="plus-circle"></i> Neue Query</h2>
  <form method="post" action="/admin/queries/create" class="create-form">
    <div class="form-row">
      <input type="text" name="name" class="input" placeholder="Name (z.B. 'Machine Learning')" required>
      <input type="text" name="query" class="input" placeholder="Suchbegriff (z.B. 'neural network')" required>
      <select name="mode" class="input" style="width: auto;">
        <option value="fts">Keyword (FTS)</option>
        <option value="semantic">Semantic</option>
      </select>
      <button type="submit" class="btn btn-primary"><i data-feather="plus"></i> Erstellen</button>
    </div>
  </form>
</section>

<style>
/* Section Header Icons */
.digest-section h2 {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.digest-section h2 svg {
  width: 1.25rem;
  height: 1.25rem;
  color: var(--primary);
}

/* Danger Text Button */
.btn-danger-text:hover {
  color: var(--error);
}

/* Digest Section Spacing */
.digest-section {
  margin-bottom: var(--section-gap);
}

.subtitle {
  color: var(--text-muted);
  margin-bottom: var(--section-gap);
}

/* Highlights */
.highlights-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.highlight-item {
  padding: var(--space-md);
  background: var(--bg-subtle);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--primary);
}

.highlight-text {
  margin: 0 0 0.5rem 0;
  font-style: italic;
  line-height: 1.5;
}

.highlight-meta {
  font-size: var(--font-size-sm);
  color: var(--text-muted);
}

.highlight-meta a {
  color: var(--primary);
  text-decoration: none;
}

.highlight-meta a:hover {
  text-decoration: underline;
}

.highlight-note {
  margin-top: 0.5rem;
  padding: 0.5rem;
  background: var(--warning-bg);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-sm);
}

/* Digests List */
.digests-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.digest-item {
  padding: var(--card-padding);
}

.digest-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  cursor: pointer;
  user-select: none;
}

.digest-header:hover {
  opacity: 0.8;
}

.digest-toggle {
  width: 1.25rem;
  height: 1.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.digest-toggle svg {
  width: 1rem;
  height: 1rem;
}

.digest-name {
  font-weight: 600;
  flex: 1;
}

.digest-badge {
  background: var(--primary-light);
  color: var(--primary);
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-sm);
  font-size: var(--font-size-sm);
  font-weight: 500;
}

.digest-meta {
  margin-top: 0.5rem;
  font-size: var(--font-size-sm);
  color: var(--text-muted);
  padding-left: 1.75rem;
}

.digest-actions {
  margin-top: 0.5rem;
  padding-left: 1.75rem;
  display: flex;
  gap: 0.5rem;
}

/* Edit Form */
.digest-edit {
  margin-top: 1rem;
  padding: 1rem;
  background: var(--bg-subtle);
  border-radius: var(--radius-md);
}

.edit-form {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
}

.edit-form .input {
  flex: 1;
  min-width: 150px;
}

/* Results */
.digest-results {
  margin-top: 1rem;
  padding: 1rem;
  background: var(--bg-subtle);
  border-radius: var(--radius-md);
}

.digest-results-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.digest-result-item {
  padding: 0.75rem;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  border-left: 2px solid var(--border);
}

.digest-result-item:hover {
  border-left-color: var(--primary);
}

.result-title {
  font-weight: 500;
  color: var(--primary);
  text-decoration: none;
}

.result-title:hover {
  text-decoration: underline;
}

.result-author {
  color: var(--text-muted);
  font-size: var(--font-size-sm);
}

.result-snippet {
  margin-top: 0.5rem;
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  line-height: 1.4;
}

/* Create Form */
.create-form .form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
}

.create-form .input {
  flex: 1;
  min-width: 200px;
}

/* Empty State */
.empty-state {
  padding: var(--space-lg);
  text-align: center;
  color: var(--text-muted);
}

/* Loading */
.loading {
  padding: 1rem;
  text-align: center;
  color: var(--text-muted);
}
</style>

{% endblock %}
