{% extends "base.html" %}
{% block content %}

<h1>Library</h1>

<form method="get" action="/library" class="row gap">
  <input class="input" type="text" name="q" value="{{ q }}" placeholder="Suche...">
  <select name="mode" class="input" style="width: auto;">
    <option value="fts" {% if mode != 'semantic' %}selected{% endif %}>Keyword (FTS)</option>
    <option value="semantic" {% if mode == 'semantic' %}selected{% endif %}>Semantic</option>
  </select>
  <button class="btn" type="submit">Search</button>
</form>

{% if q and mode == 'semantic' %}
<p class="muted" style="margin: 0.5rem 0;">Semantische Suche: Findet konzeptuell aehnliche Dokumente</p>
{% endif %}

<div class="list">
  {% for r in rows %}
    <div class="item" x-data="{ showContext: false }">
      <div class="title">
        <a href="/documents/{{ r.id }}">{{ r.title or ("Doc #" ~ r.id) }}</a>
        {% if r.distance is defined %}
          <span class="badge" title="Distanz (kleiner = aehnlicher)">{{ "%.3f"|format(r.distance) }}</span>
        {% endif %}
      </div>

      {% if r.chunk_text %}
      <div class="citation">
        <blockquote class="cite-text">{{ r.chunk_text[:300] }}{% if r.chunk_text|length > 300 %}...{% endif %}</blockquote>
        <div class="cite-meta">
          {% if r.chunk_index is defined %}
          <span title="Position im Dokument">Absatz {{ r.chunk_index + 1 }}</span>
          {% endif %}
          {% if r.char_start is defined %}
          <span title="Zeichenposition">Zeichen {{ r.char_start }}-{{ r.char_end }}</span>
          {% endif %}
          {% if r.context_before or r.context_after %}
          <button class="btn btn-sm" @click="showContext = !showContext">
            <span x-show="!showContext">Mehr Kontext</span>
            <span x-show="showContext">Weniger</span>
          </button>
          {% endif %}
        </div>
      </div>

      <div class="context-box" x-show="showContext" x-transition>
        {% if r.context_before %}
        <div class="context-before">{{ r.context_before }}</div>
        {% endif %}
        <div class="context-highlight">{{ r.chunk_text }}</div>
        {% if r.context_after %}
        <div class="context-after">{{ r.context_after }}</div>
        {% endif %}
      </div>
      {% endif %}

      <div class="meta">
        <span>{{ r.author or "" }}</span>
        <span>{{ r.saved_at or "" }}</span>
        {% if r.url %}
          <a href="{{ r.url }}" target="_blank">Quelle</a>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<style>
.citation {
  margin: 0.75rem 0;
}
.cite-text {
  margin: 0;
  padding: 0.75rem;
  border-left: 3px solid rgba(120,120,120,0.3);
  background: rgba(120,120,120,0.05);
  border-radius: 0 8px 8px 0;
  font-style: italic;
  line-height: 1.5;
}
.cite-meta {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-top: 0.5rem;
  font-size: 0.85em;
  opacity: 0.7;
}
.context-box {
  margin: 0.75rem 0;
  padding: 1rem;
  background: rgba(120,120,120,0.05);
  border-radius: 8px;
  font-size: 0.9em;
  line-height: 1.6;
}
.context-before, .context-after {
  opacity: 0.6;
}
.context-highlight {
  background: var(--warning-bg);
  padding: 0.5rem;
  border-radius: 4px;
  margin: 0.5rem 0;
}
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  background: rgba(120,120,120,0.15);
  font-size: 0.75em;
  font-weight: normal;
}
.muted {
  opacity: 0.7;
}
</style>

{% endblock %}
