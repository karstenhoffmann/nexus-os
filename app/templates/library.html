{% extends "base.html" %}
{% from "macros/icons.html" import icon %}
{% block content %}

<div x-data="libraryApp()" x-init="init()">

  <!-- Hero: Title + Subtitle -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold">Library</h1>
    <p class="text-base-content/60 text-sm mt-1">Suche und durchstoebere deine gespeicherten Inhalte</p>
  </div>

  <!-- Quick Stats Bar -->
  <div class="stats stats-vertical sm:stats-horizontal shadow bg-base-100 w-full mb-6">
    <div class="stat">
      <div class="stat-title text-xs">Dokumente</div>
      <div class="stat-value text-xl">{{ stats.total_docs }}</div>
      <div class="stat-desc">{{ stats.categories_count }} Kategorien</div>
    </div>
    <div class="stat">
      <div class="stat-title text-xs">Highlights</div>
      <div class="stat-value text-xl text-warning">{{ stats.total_highlights }}</div>
      <div class="stat-desc">markierte Stellen</div>
    </div>
    <div class="stat">
      <div class="stat-title text-xs">Woerter</div>
      <div class="stat-value text-xl">{{ "{:,}".format(stats.total_words).replace(",", ".") }}</div>
      <div class="stat-desc">ca. {{ stats.reading_hours }}h Lesezeit</div>
    </div>
  </div>

  <!-- Search Card -->
  <div class="card bg-base-100 shadow-md mb-6">
    <div class="card-body gap-4">
      <!-- Row 1: Mode Tabs + Content Toggles -->
      <div class="flex flex-wrap items-center justify-between gap-4">
        <!-- Search Mode Tabs -->
        <div class="join">
          <button
            class="btn btn-sm join-item transition-all"
            :class="mode === 'semantic' ? 'btn-active' : 'hover:bg-base-200'"
            @click="mode = 'semantic'; search()"
          >
            {{ icon("zap") }} <span class="hidden sm:inline ml-1">Semantic</span>
          </button>
          <button
            class="btn btn-sm join-item transition-all"
            :class="mode === 'fts' ? 'btn-active' : 'hover:bg-base-200'"
            @click="mode = 'fts'; search()"
          >
            {{ icon("type") }} <span class="hidden sm:inline ml-1">Keyword</span>
          </button>
        </div>

        <!-- Content Toggles -->
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer select-none group">
            <span class="text-xs text-base-content/70 group-hover:text-base-content transition-colors">Volltext</span>
            <input type="checkbox" class="toggle toggle-sm toggle-primary" x-model="fulltext" @change="search()">
          </label>
          <label class="flex items-center gap-2 cursor-pointer select-none group">
            <span class="text-xs text-base-content/70 group-hover:text-base-content transition-colors">Highlights</span>
            <input type="checkbox" class="toggle toggle-sm toggle-warning" x-model="highlights" @change="search()">
          </label>
        </div>
      </div>

      <!-- Row 2: Search Input -->
      <form @submit.prevent="search()" class="flex gap-2">
        <label class="input input-bordered flex items-center gap-3 flex-1 focus-within:input-primary focus-within:border-primary transition-all">
          <span class="text-base-content/40">{{ icon("search") }}</span>
          <input
            type="text"
            class="grow bg-transparent outline-none"
            x-model="q"
            placeholder="Suche nach Themen, Autoren, Inhalten..."
            @keyup.enter="search()"
          >
        </label>
        <button class="btn btn-primary" type="submit" :disabled="loading">
          <span x-show="!loading">Suchen</span>
          <span x-show="loading" class="loading loading-spinner loading-sm"></span>
        </button>
      </form>

      <!-- Row 3: Category Filter - DaisyUI Filter component with checkboxes -->
      <div class="flex flex-wrap items-center gap-2 pt-3 border-t border-base-200">
        <span class="text-xs text-base-content/50 uppercase tracking-wide font-medium mr-2">Typ:</span>

        <!-- DaisyUI Filter using checkboxes -->
        <div class="flex flex-wrap gap-1">
          <template x-for="cat in allCategories" :key="cat">
            <input
              type="checkbox"
              class="btn btn-sm"
              :aria-label="cat + ' (' + (categoryCounts[cat] || 0) + ')'"
              :checked="categories.includes(cat)"
              @change="toggleCategory(cat)"
            >
          </template>
          <!-- Reset button -->
          <input
            type="reset"
            class="btn btn-sm btn-square"
            value="Ã—"
            x-show="categories.length > 0"
            @click="categories = []; search()"
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="card bg-base-100 shadow-md">
    <div class="card-body">
      <!-- Results Header -->
      <div class="flex items-center justify-between" x-show="total > 0 && !loading">
        <div class="flex items-center gap-2">
          <span class="text-lg font-semibold" x-text="total.toLocaleString()"></span>
          <span class="text-base-content/60">Ergebnisse</span>
          <span class="badge badge-sm badge-ghost" x-show="q" x-text="mode === 'semantic' ? 'Semantic' : 'Keyword'"></span>
        </div>
        <div class="text-sm text-base-content/50" x-show="q">
          <span x-text="'\"' + q + '\"'"></span>
        </div>
      </div>

      <!-- Loading Skeleton -->
      <div x-show="loading" x-transition class="space-y-4 py-4">
        <template x-for="i in 5" :key="i">
          <div class="flex items-center gap-4 animate-pulse">
            <div class="flex-1 space-y-2">
              <div class="h-4 bg-base-300 rounded w-3/4"></div>
              <div class="h-3 bg-base-200 rounded w-1/2"></div>
            </div>
            <div class="h-4 bg-base-200 rounded w-16"></div>
            <div class="h-4 bg-base-200 rounded w-20"></div>
            <div class="h-4 bg-base-200 rounded w-16"></div>
          </div>
        </template>
      </div>

      <!-- Results Table -->
      <div id="results" x-show="!loading" x-transition>
        {% include "partials/library_results.html" %}
      </div>
    </div>
  </div>

</div>

<script>
function libraryApp() {
  return {
    q: '{{ q|e }}',
    mode: '{{ mode }}',
    fulltext: {{ 'true' if fulltext else 'false' }},
    highlights: {{ 'true' if highlights else 'false' }},
    categories: {{ categories_json|safe }},
    allCategories: {{ all_categories_json|safe }},
    categoryCounts: {{ category_counts|tojson|safe }},
    sortBy: '{{ sort_by }}',
    sortDir: '{{ sort_dir }}',
    total: {{ total }},
    loading: false,

    init() {
      // Ready
    },

    get filterUrl() {
      let params = new URLSearchParams();
      if (this.q) params.set('q', this.q);
      params.set('mode', this.mode);
      params.set('fulltext', this.fulltext);
      params.set('highlights', this.highlights);
      params.set('sort_by', this.sortBy);
      params.set('sort_dir', this.sortDir);
      if (this.categories.length) params.set('categories', this.categories.join(','));
      return '/api/library/results?' + params.toString();
    },

    toggleCategory(cat) {
      const idx = this.categories.indexOf(cat);
      if (idx > -1) {
        this.categories.splice(idx, 1);
      } else {
        this.categories.push(cat);
      }
      this.search();
    },

    toggleSort(col) {
      if (this.sortBy === col) {
        this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        this.sortBy = col;
        this.sortDir = col === 'distance' ? 'asc' : 'desc';
      }
      this.search();
    },

    search() {
      this.loading = true;
      htmx.ajax('GET', this.filterUrl, {
        target: '#results',
        swap: 'innerHTML'
      }).then(() => {
        this.loading = false;
      }).catch(() => {
        this.loading = false;
      });
    }
  };
}
</script>

{% endblock %}
