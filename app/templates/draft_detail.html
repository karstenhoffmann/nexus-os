{% extends "base.html" %}
{% from "macros/icons.html" import icon %}
{% block content %}

<div class="breadcrumbs text-sm mb-4">
  <ul>
    <li><a href="/drafts">{{ icon("arrow-left") }} Drafts</a></li>
  </ul>
</div>

<div class="mb-6" x-data="{ editingTitle: false }">
  <div class="flex items-center gap-4 mb-2">
    <div class="w-12 h-12 flex items-center justify-center bg-base-200 rounded-lg text-base-content/60">
      {% if draft.kind == 'linkedin' %}{{ icon("linkedin") }}
      {% elif draft.kind == 'article' %}{{ icon("file-text") }}
      {% else %}{{ icon("edit-3") }}{% endif %}
    </div>
    <div class="flex items-center gap-2" x-show="!editingTitle">
      <h1 class="m-0">{{ draft.title or ("Draft #" ~ draft.id) }}</h1>
      <button class="btn btn-ghost btn-sm btn-circle" @click="editingTitle = true" title="Titel bearbeiten">
        {{ icon("edit-2") }}
      </button>
    </div>
    <form x-show="editingTitle" action="/drafts/{{ draft.id }}/title" method="post" class="flex items-center gap-2 flex-1">
      <input type="text" name="title" class="input input-bordered flex-1" value="{{ draft.title or '' }}" placeholder="Titel eingeben" autofocus>
      <button type="submit" class="btn btn-primary btn-sm">Speichern</button>
      <button type="button" class="btn btn-outline btn-sm" @click="editingTitle = false">Abbrechen</button>
    </form>
  </div>
  <div class="flex items-center gap-4 ml-16">
    <span class="badge {% if draft.status == 'working' %}badge-warning{% elif draft.status == 'published' %}badge-success{% else %}badge-ghost{% endif %}">{{ draft.status }}</span>
    <span class="flex items-center gap-1 text-sm text-base-content/60">{{ icon("calendar") }} {{ draft.created_at[:10] if draft.created_at else '' }}</span>
    <span class="flex items-center gap-1 text-sm text-base-content/60">{{ icon("clock") }} {{ draft.versions|length }} Version{% if draft.versions|length != 1 %}en{% endif %}</span>
  </div>
</div>

<!-- Status Actions -->
<div class="flex gap-2 mb-6">
  {% if draft.status == 'working' %}
    <form action="/drafts/{{ draft.id }}/status" method="post" class="inline">
      <input type="hidden" name="status" value="published">
      <button type="submit" class="btn btn-success btn-sm">
        {{ icon("check-circle") }} Als fertig markieren
      </button>
    </form>
    <form action="/drafts/{{ draft.id }}/status" method="post" class="inline">
      <input type="hidden" name="status" value="archived">
      <button type="submit" class="btn btn-outline btn-sm">
        {{ icon("archive") }} Archivieren
      </button>
    </form>
  {% elif draft.status == 'published' %}
    <form action="/drafts/{{ draft.id }}/status" method="post" class="inline">
      <input type="hidden" name="status" value="working">
      <button type="submit" class="btn btn-outline btn-sm">
        {{ icon("edit") }} Weiter bearbeiten
      </button>
    </form>
    <form action="/drafts/{{ draft.id }}/status" method="post" class="inline">
      <input type="hidden" name="status" value="archived">
      <button type="submit" class="btn btn-outline btn-sm">
        {{ icon("archive") }} Archivieren
      </button>
    </form>
  {% else %}
    <form action="/drafts/{{ draft.id }}/status" method="post" class="inline">
      <input type="hidden" name="status" value="working">
      <button type="submit" class="btn btn-outline btn-sm">
        {{ icon("rotate-ccw") }} Reaktivieren
      </button>
    </form>
  {% endif %}
</div>

<!-- New Version Form -->
<div class="card bg-base-100 shadow-md mb-6" x-data="draftEditor()">
  <div class="card-body">
    <h2 class="card-title text-lg">{{ icon("edit-3") }} Neue Version erstellen</h2>
    <form action="/drafts/{{ draft.id }}/version" method="post">
      <div class="form-control mb-4">
        <label class="label" for="text">
          <span class="label-text font-medium">Inhalt</span>
        </label>
        <textarea name="text" id="draft-text" class="textarea textarea-bordered w-full min-h-60" rows="10" x-model="text" @input="updateCount()" required>{{ draft.versions[0].text if draft.versions else '' }}</textarea>
        {% if draft.kind == 'linkedin' %}
        <label class="label">
          <span class="label-text-alt" :class="{ 'text-warning': charCount > 2800, 'text-error': charCount > 3000 }">
            <span x-text="charCount"></span> / 3000 Zeichen
          </span>
        </label>
        {% endif %}
      </div>
      <div class="form-control mb-4">
        <label class="label" for="note">
          <span class="label-text font-medium">Notiz zu dieser Version (optional)</span>
        </label>
        <input type="text" name="note" id="note" class="input input-bordered w-full" placeholder="z.B. Feedback von Max eingearbeitet">
      </div>
      <button type="submit" class="btn btn-primary">
        {{ icon("save") }} Version speichern
      </button>
    </form>
  </div>
</div>

<!-- Version History -->
<div class="card bg-base-100 shadow-md">
  <div class="card-body">
    <h2 class="card-title text-lg">{{ icon("git-branch") }} Versionshistorie</h2>
    {% if draft.versions %}
    <div class="flex flex-col gap-2">
      {% for v in draft.versions %}
      <div class="collapse collapse-arrow bg-base-200" x-data="{ expanded: {{ 'true' if loop.first else 'false' }} }">
        <input type="checkbox" {% if loop.first %}checked{% endif %} />
        <div class="collapse-title font-medium flex items-center gap-4">
          <span class="text-primary font-bold">v{{ v.version_index }}</span>
          <span class="text-sm text-base-content/60">{{ v.created_at[:16] if v.created_at else '' }}</span>
          {% if v.note %}
          <span class="text-sm italic text-base-content/70">{{ v.note }}</span>
          {% endif %}
        </div>
        <div class="collapse-content">
          <pre class="bg-base-100 p-4 rounded-lg text-sm whitespace-pre-wrap break-words max-h-72 overflow-y-auto mb-2">{{ v.text }}</pre>
          <button class="btn btn-outline btn-sm" onclick="navigator.clipboard.writeText(this.nextElementSibling.innerText)">
            {{ icon("copy") }} Kopieren
          </button>
          <span class="hidden">{{ v.text }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-base-content/60 italic">Noch keine Versionen vorhanden.</p>
    {% endif %}
  </div>
</div>

<!-- Styles migrated to DaisyUI classes -->

<script>
function draftEditor() {
  return {
    text: '',
    charCount: 0,
    init() {
      const textarea = document.getElementById('draft-text');
      if (textarea) {
        this.text = textarea.value;
        this.charCount = this.text.length;
      }
    },
    updateCount() {
      this.charCount = this.text.length;
    }
  };
}
</script>

{% endblock %}
