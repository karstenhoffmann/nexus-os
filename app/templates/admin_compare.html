{% extends "base.html" %}
{% from "macros/icons.html" import icon %}
{% block content %}

<div class="max-w-4xl mx-auto" x-data="compareApp()" x-init="init()">

  <!-- Hero Search Section - Primary Focus -->
  <section class="card bg-base-100 shadow-lg mb-6">
    <div class="card-body">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold mb-2">Modell-Vergleich</h1>
        <p class="text-base-content/60">Vergleiche Embedding-Modelle mit derselben Suchanfrage</p>
      </div>

      <!-- Search Form - Prominent -->
      <form @submit.prevent="runComparison()" class="max-w-2xl mx-auto">
        <div class="join w-full shadow-sm">
          <input
            type="text"
            class="input input-bordered join-item flex-1 text-lg"
            placeholder="Suchanfrage eingeben..."
            x-model="query"
            :disabled="loading"
          >
          <button class="btn btn-primary join-item px-6" type="submit" :disabled="loading || !query.trim()">
            <span x-show="!loading" class="inline-flex items-center gap-2 whitespace-nowrap">
              {{ icon("search", "size-5 shrink-0") }}
              <span class="hidden sm:inline">Vergleichen</span>
            </span>
            <span x-show="loading" class="inline-flex items-center gap-2">
              <span class="loading loading-spinner loading-sm"></span>
              <span class="hidden sm:inline">Läuft...</span>
            </span>
          </button>
        </div>
      </form>

      <!-- Provider Status - Compact Inline -->
      <div class="flex flex-wrap justify-center gap-4 mt-6">
        <template x-for="provider in providers" :key="provider.provider">
          <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-base-200/70 text-sm">
            <span x-show="provider.healthy" class="w-2 h-2 rounded-full bg-success"></span>
            <span x-show="!provider.healthy" class="w-2 h-2 rounded-full bg-error"></span>
            <span class="font-medium" x-text="provider.provider"></span>
            <span class="text-base-content/50" x-text="provider.latency_ms + 'ms'"></span>
          </div>
        </template>
        <template x-if="providers.length === 0">
          <div class="text-base-content/40 text-sm">Provider werden geladen...</div>
        </template>
      </div>
    </div>
  </section>

  <!-- Results Section - Appears After Search -->
  <section x-show="results.length > 0" x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="opacity-0 translate-y-4"
           x-transition:enter-end="opacity-100 translate-y-0"
           class="space-y-4">

    <!-- Results Header -->
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">
        Ergebnisse für "<span class="text-primary" x-text="lastQuery"></span>"
      </h2>
      <button @click="results = []; lastQuery = ''" class="btn btn-ghost btn-sm">
        {{ icon("x", "size-4 shrink-0") }} Zurücksetzen
      </button>
    </div>

    <!-- Quick Stats - Key Insights First -->
    <div class="stats stats-horizontal bg-base-100 shadow w-full" x-show="results.length === 2">
      <div class="stat">
        <div class="stat-title text-xs">Schneller</div>
        <div class="stat-value text-lg text-success" x-text="results[0]?.latency_ms < results[1]?.latency_ms ? results[0]?.provider : results[1]?.provider"></div>
        <div class="stat-desc" x-text="Math.abs(results[0]?.latency_ms - results[1]?.latency_ms) + 'ms Unterschied'"></div>
      </div>
      <div class="stat">
        <div class="stat-title text-xs">Übereinstimmung</div>
        <div class="stat-value text-lg" x-text="calculateOverlap() + '/5'"></div>
        <div class="stat-desc">Top-Ergebnisse gleich</div>
      </div>
      <div class="stat">
        <div class="stat-title text-xs">Günstiger</div>
        <div class="stat-value text-lg text-success" x-text="results[0]?.cost_usd <= results[1]?.cost_usd ? results[0]?.provider : results[1]?.provider"></div>
        <div class="stat-desc" x-text="results[0]?.cost_usd === 0 && results[1]?.cost_usd === 0 ? 'Beide kostenlos' : (results[0]?.cost_usd === 0 || results[1]?.cost_usd === 0 ? 'Lokal = gratis' : 'Preisvergleich')"></div>
      </div>
    </div>

    <!-- Side-by-Side Results -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <template x-for="(result, resultIdx) in results" :key="result.provider">
        <div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow">
          <div class="card-body p-4">
            <!-- Provider Header -->
            <div class="flex items-center justify-between pb-3 border-b border-base-200">
              <div class="flex items-center gap-2">
                <span class="font-bold text-lg" x-text="result.provider"></span>
                <span class="badge badge-sm" :class="result.cost_usd === 0 ? 'badge-success' : 'badge-neutral'"
                      x-text="result.cost_usd === 0 ? 'Gratis' : '$' + result.cost_usd.toFixed(6)"></span>
              </div>
              <div class="text-sm text-base-content/60">
                <span x-text="result.latency_ms"></span>ms
              </div>
            </div>

            <!-- Model Info -->
            <div class="text-xs text-base-content/50 mt-2 mb-3" x-text="result.model"></div>

            <!-- Results List -->
            <div class="space-y-2" x-show="result.documents.length > 0">
              <template x-for="(doc, idx) in result.documents" :key="doc.id">
                <a :href="'/documents/' + doc.id"
                   class="flex items-start gap-3 p-2 -mx-2 rounded-lg hover:bg-base-200/50 transition-colors group">
                  <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
                       :class="idx === 0 ? 'bg-primary text-primary-content' : 'bg-base-200 text-base-content/70'"
                       x-text="idx + 1"></div>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm group-hover:text-primary transition-colors truncate"
                         x-text="doc.title || ('Doc #' + doc.id)"></div>
                    <div class="text-xs text-base-content/50 mt-0.5">
                      Distanz: <span x-text="doc.distance.toFixed(4)"></span>
                    </div>
                  </div>
                </a>
              </template>
            </div>

            <!-- Empty State -->
            <div x-show="result.documents.length === 0 && !result.error"
                 class="text-center py-6 text-base-content/50">
              <div class="text-2xl mb-1">∅</div>
              <div class="text-sm">Keine Ergebnisse</div>
            </div>

            <!-- Error State -->
            <div x-show="result.error" class="alert alert-error alert-sm mt-2">
              <span class="text-xs" x-text="result.error"></span>
            </div>
          </div>
        </div>
      </template>
    </div>
  </section>

  <!-- Empty State - Before Search -->
  <section x-show="results.length === 0 && !loading" class="text-center py-12">
    <div class="text-6xl mb-4 opacity-20">⚖️</div>
    <p class="text-base-content/50">Gib eine Suchanfrage ein, um die Modelle zu vergleichen</p>
  </section>

  <!-- Loading State -->
  <section x-show="loading" class="space-y-4">
    <div class="flex items-center justify-center gap-3 py-8">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <span class="text-base-content/60">Vergleiche Modelle...</span>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card bg-base-100 shadow-md animate-pulse">
        <div class="card-body p-4 space-y-3">
          <div class="h-6 bg-base-200 rounded w-1/3"></div>
          <div class="h-4 bg-base-200 rounded w-1/4"></div>
          <div class="space-y-2 mt-4">
            <div class="h-12 bg-base-200 rounded"></div>
            <div class="h-12 bg-base-200 rounded"></div>
            <div class="h-12 bg-base-200 rounded"></div>
          </div>
        </div>
      </div>
      <div class="card bg-base-100 shadow-md animate-pulse">
        <div class="card-body p-4 space-y-3">
          <div class="h-6 bg-base-200 rounded w-1/3"></div>
          <div class="h-4 bg-base-200 rounded w-1/4"></div>
          <div class="space-y-2 mt-4">
            <div class="h-12 bg-base-200 rounded"></div>
            <div class="h-12 bg-base-200 rounded"></div>
            <div class="h-12 bg-base-200 rounded"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Hints - Collapsed by Default -->
  <section class="mt-8">
    <div class="collapse collapse-arrow bg-base-100 shadow-sm">
      <input type="checkbox" />
      <div class="collapse-title text-sm font-medium text-base-content/70">
        {{ icon("info", "size-4 shrink-0 inline mr-1") }} Hinweise zur Interpretation
      </div>
      <div class="collapse-content">
        <ul class="text-sm space-y-2 text-base-content/70 pt-2">
          <li class="flex gap-2">
            <span class="text-primary">•</span>
            <span><strong>Distanz:</strong> Niedriger = ähnlicher (0.0 - 2.0 bei Cosine)</span>
          </li>
          <li class="flex gap-2">
            <span class="text-primary">•</span>
            <span><strong>OpenAI:</strong> Beste Qualität, ~$0.00002 pro Suche</span>
          </li>
          <li class="flex gap-2">
            <span class="text-primary">•</span>
            <span><strong>Ollama:</strong> Lokal, kostenlos, etwas geringere Qualität</span>
          </li>
          <li class="flex gap-2">
            <span class="text-primary">•</span>
            <span>Ollama benötigt: <code class="bg-base-200 px-1 rounded text-xs">ollama pull nomic-embed-text</code></span>
          </li>
        </ul>
      </div>
    </div>
  </section>
</div>

<script>
function compareApp() {
  return {
    query: '',
    lastQuery: '',
    loading: false,
    providers: [],
    results: [],

    async init() {
      try {
        const resp = await fetch('/api/providers/health');
        const data = await resp.json();
        this.providers = data.providers || [];
      } catch (e) {
        console.error('Failed to load providers:', e);
      }
    },

    async runComparison() {
      if (!this.query.trim()) return;

      this.loading = true;
      this.lastQuery = this.query;
      this.results = [];

      const providers = ['openai', 'ollama'];

      for (const provider of providers) {
        try {
          const start = Date.now();
          const resp = await fetch(`/api/compare/search?q=${encodeURIComponent(this.query)}&provider=${provider}&limit=5`);
          const data = await resp.json();
          const latency = Date.now() - start;

          this.results.push({
            provider: data.provider || provider,
            model: data.model || 'unknown',
            latency_ms: data.latency_ms || latency,
            cost_usd: data.cost_usd || 0,
            documents: data.results || [],
            error: data.error || null
          });
        } catch (e) {
          this.results.push({
            provider: provider,
            model: 'unknown',
            latency_ms: 0,
            cost_usd: 0,
            documents: [],
            error: e.message
          });
        }
      }

      this.loading = false;
    },

    calculateOverlap() {
      if (this.results.length < 2) return 0;
      const ids1 = new Set(this.results[0].documents.slice(0, 5).map(d => d.id));
      const ids2 = new Set(this.results[1].documents.slice(0, 5).map(d => d.id));
      let overlap = 0;
      for (const id of ids1) {
        if (ids2.has(id)) overlap++;
      }
      return overlap;
    }
  };
}
</script>

{% endblock %}
