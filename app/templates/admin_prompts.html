{% extends "base.html" %}
{% from "macros/icons.html" import icon %}
{% block content %}

<h1 class="text-2xl font-bold mb-6">Prompt-Vorlagen</h1>

<div x-data="promptsApp()" x-init="init()">

  <!-- Info Card -->
  <div class="card bg-base-100 shadow-md mb-6">
    <div class="card-body">
      <h2 class="card-title">Was sind Prompt-Vorlagen?</h2>
      <p>
        Prompts sind die Anweisungen, die an das LLM (Language Model) gesendet werden.
        Hier kannst Du die Vorlagen anpassen, um die Qualitaet der generierten Inhalte zu verbessern.
      </p>
      <p class="text-base-content/60 text-sm mt-2">
        <strong>Tipp:</strong> Aenderungen werden sofort wirksam. Du kannst jederzeit zum Standard zuruecksetzen.
      </p>
    </div>
  </div>

  <!-- Loading State -->
  <div class="card bg-base-100 shadow-md mb-6" x-show="loading">
    <div class="card-body">
      <div class="skeleton h-6 w-3/5"></div>
      <div class="skeleton h-4 w-4/5 mt-2"></div>
      <div class="skeleton h-4 w-2/5 mt-2"></div>
    </div>
  </div>

  <!-- Categories -->
  <template x-for="(cat, catKey) in categories" :key="catKey">
    <div class="card bg-base-100 shadow-md mb-6">
      <div class="card-body">
        <!-- Category Header -->
        <div class="flex items-start gap-4 mb-4">
          <div class="w-10 h-10 rounded-lg bg-base-200 flex items-center justify-center flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-base-content/60"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          </div>
          <div class="flex-1">
            <h2 class="card-title text-lg" x-text="cat.name"></h2>
            <p class="text-base-content/60 text-sm" x-text="cat.description"></p>
          </div>
          <span class="badge badge-ghost" x-show="cat.coming_soon">Demn√§chst</span>
        </div>

        <!-- Prompts List -->
        <div class="flex flex-col gap-3" x-show="!cat.coming_soon">
          <template x-for="prompt in cat.prompts" :key="prompt.key">
            <div class="flex items-start justify-between p-4 rounded-lg bg-base-200 border border-base-300"
                 :class="{'border-primary bg-primary/5': prompt.is_custom}">
              <div class="flex-1 min-w-0">
                <div class="font-medium flex items-center gap-2 flex-wrap">
                  <span x-text="prompt.name"></span>
                  <span class="badge badge-primary badge-sm" x-show="prompt.is_custom">Angepasst</span>
                </div>
                <div class="text-base-content/60 text-sm mt-1" x-text="prompt.description"></div>
                <div class="flex gap-4 mt-2">
                  <span class="inline-flex items-center gap-1 text-xs text-base-content/50">
                    {{ icon("thermometer") }}
                    <span x-text="'Temp: ' + prompt.temperature"></span>
                  </span>
                  <span class="inline-flex items-center gap-1 text-xs text-base-content/50">
                    {{ icon("hash") }}
                    <span x-text="'Max: ' + prompt.max_tokens + ' Tokens'"></span>
                  </span>
                </div>
              </div>
              <button class="btn btn-sm btn-outline ml-4 whitespace-nowrap inline-flex" @click="editPrompt(prompt.key)">
                {{ icon("edit-2") }}
                Bearbeiten
              </button>
            </div>
          </template>
        </div>

        <!-- Coming Soon Message -->
        <div class="alert bg-base-200" x-show="cat.coming_soon">
          {{ icon("clock") }}
          <span>Diese Kategorie wird in einer zukuenftigen Version verfuegbar sein.</span>
        </div>
      </div>
    </div>
  </template>

  <!-- Edit Modal -->
  <dialog class="modal" :class="{'modal-open': editingPrompt}" x-cloak>
    <div class="modal-box w-11/12 max-w-3xl">
      <!-- Modal Header -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg" x-text="editingPrompt?.name"></h3>
        <button class="btn btn-sm btn-circle btn-ghost" @click="closeModal()">
          {{ icon("x") }}
        </button>
      </div>

      <!-- Description -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text font-medium">Beschreibung</span>
        </label>
        <p class="text-base-content/60 text-sm" x-text="editingPrompt?.description"></p>
      </div>

      <!-- Variables Reference -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text font-medium">Verfuegbare Variablen</span>
        </label>
        <div class="flex flex-wrap gap-2 mb-2">
          <template x-for="v in editingPrompt?.variables || []" :key="v">
            <kbd class="kbd kbd-sm" x-text="'{' + v + '}'"></kbd>
          </template>
        </div>
        <p class="text-base-content/50 text-xs">Diese Variablen werden zur Laufzeit mit den entsprechenden Werten ersetzt.</p>
      </div>

      <!-- Template Editor -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text font-medium">Template</span>
        </label>
        <textarea
          class="textarea textarea-bordered font-mono text-sm min-h-48 leading-relaxed"
          x-model="editingPrompt.template"
          rows="12"
          spellcheck="false"
        ></textarea>
      </div>

      <!-- Settings Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Temperature</span>
          </label>
          <input
            type="number"
            class="input input-bordered"
            x-model.number="editingPrompt.temperature"
            min="0"
            max="2"
            step="0.1"
          >
          <label class="label">
            <span class="label-text-alt text-base-content/50">0 = deterministisch, 1 = kreativ, 2 = sehr kreativ</span>
          </label>
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Max Tokens</span>
          </label>
          <input
            type="number"
            class="input input-bordered"
            x-model.number="editingPrompt.max_tokens"
            min="50"
            max="4000"
            step="50"
          >
          <label class="label">
            <span class="label-text-alt text-base-content/50">Maximale Laenge der Antwort</span>
          </label>
        </div>
      </div>

      <!-- Changed Indicator -->
      <div class="alert alert-warning mb-4" x-show="hasChanges()">
        {{ icon("alert-circle") }}
        <span>Ungespeicherte Aenderungen</span>
      </div>

      <!-- Modal Actions -->
      <div class="modal-action flex-wrap gap-2">
        <button
          class="btn btn-outline btn-sm whitespace-nowrap inline-flex"
          @click="resetPrompt()"
          :disabled="!editingPrompt?.is_custom && !hasChanges()"
          x-show="editingPrompt?.is_custom || hasChanges()"
        >
          {{ icon("rotate-ccw") }}
          Auf Standard zuruecksetzen
        </button>
        <div class="flex-1"></div>
        <button class="btn btn-ghost" @click="closeModal()">Abbrechen</button>
        <button
          class="btn btn-primary"
          @click="savePrompt()"
          :disabled="saving || !hasChanges()"
        >
          <span x-show="!saving">Speichern</span>
          <span x-show="saving" class="loading loading-spinner loading-sm"></span>
          <span x-show="saving">Speichern...</span>
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button @click="closeModal()">close</button>
    </form>
  </dialog>

</div>

<script>
function promptsApp() {
  return {
    loading: true,
    categories: {},
    editingPrompt: null,
    originalPrompt: null,
    saving: false,

    async init() {
      await this.loadPrompts();
      this.loading = false;
    },

    async loadPrompts() {
      try {
        const res = await fetch('/api/admin/prompts');
        const data = await res.json();
        this.categories = data.categories || {};
      } catch (e) {
        console.error('Failed to load prompts:', e);
      }
    },

    async editPrompt(key) {
      try {
        const res = await fetch(`/api/admin/prompts/${key}`);
        const data = await res.json();
        this.editingPrompt = { ...data };
        this.originalPrompt = { ...data };
      } catch (e) {
        console.error('Failed to load prompt:', e);
      }
    },

    closeModal() {
      if (this.hasChanges()) {
        if (!confirm('Ungespeicherte Aenderungen verwerfen?')) {
          return;
        }
      }
      this.editingPrompt = null;
      this.originalPrompt = null;
    },

    hasChanges() {
      if (!this.editingPrompt || !this.originalPrompt) return false;
      return (
        this.editingPrompt.template !== this.originalPrompt.template ||
        this.editingPrompt.temperature !== this.originalPrompt.temperature ||
        this.editingPrompt.max_tokens !== this.originalPrompt.max_tokens
      );
    },

    async savePrompt() {
      if (!this.editingPrompt || this.saving) return;

      this.saving = true;
      try {
        const formData = new FormData();
        formData.append('template', this.editingPrompt.template);
        formData.append('temperature', this.editingPrompt.temperature);
        formData.append('max_tokens', this.editingPrompt.max_tokens);

        const res = await fetch(`/api/admin/prompts/${this.editingPrompt.key}`, {
          method: 'PUT',
          body: formData,
        });
        const data = await res.json();

        if (data.success) {
          await this.loadPrompts();
          this.editingPrompt = null;
          this.originalPrompt = null;
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      } catch (e) {
        console.error('Failed to save prompt:', e);
        alert('Fehler beim Speichern');
      } finally {
        this.saving = false;
      }
    },

    async resetPrompt() {
      if (!this.editingPrompt) return;

      if (!confirm('Prompt auf Standardwerte zuruecksetzen?')) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/prompts/${this.editingPrompt.key}/reset`, {
          method: 'POST',
        });
        const data = await res.json();

        if (data.success) {
          await this.loadPrompts();
          this.editingPrompt = null;
          this.originalPrompt = null;
        }
      } catch (e) {
        console.error('Failed to reset prompt:', e);
        alert('Fehler beim Zuruecksetzen');
      }
    }
  };
}
</script>

{% endblock %}
